<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uzbekistan 3D Terrain Globe - Day 5 Earth</title>

    <!-- Cesium CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        #title-panel {
            top: 20px;
            left: 20px;
            max-width: 350px;
        }

        #title-panel h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #ff6b6b;
        }

        #title-panel h2 {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 12px;
            font-weight: normal;
        }

        #title-panel p {
            font-size: 13px;
            line-height: 1.5;
            margin: 8px 0;
        }

        #navigation-panel {
            top: 20px;
            right: 20px;
            max-width: 280px;
        }

        #navigation-panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #4ecdc4;
            border-bottom: 2px solid #4ecdc4;
            padding-bottom: 8px;
        }

        .nav-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin: 8px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .nav-button:active {
            transform: translateY(0);
        }

        .nav-button::before {
            content: 'üìç ';
            margin-right: 8px;
        }

        #info-panel {
            bottom: 20px;
            left: 20px;
            min-width: 300px;
        }

        #info-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #95e1d3;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
        }

        .info-label {
            color: #aaa;
        }

        .info-value {
            color: white;
            font-weight: 600;
        }

        #legend-panel {
            bottom: 20px;
            right: 20px;
            max-width: 250px;
        }

        #legend-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #f38181;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 12px;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        #controls-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            padding: 20px 30px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            animation: fadeOut 5s forwards;
        }

        @keyframes fadeOut {
            0%, 80% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 2000;
        }

        /* Mapbox token input */
        #token-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        #token-form {
            background: #1a1a2e;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        #token-form h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
        }

        #token-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #4ecdc4;
            border-radius: 6px;
            background: #16213e;
            color: white;
            font-size: 14px;
        }

        #token-form button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        #token-form button:hover {
            opacity: 0.9;
        }

        #token-form p {
            color: #aaa;
            font-size: 12px;
            margin-top: 15px;
        }

        #token-form a {
            color: #4ecdc4;
        }
    </style>
</head>
<body>
    <!-- Token Input Modal -->
    <div id="token-modal">
        <div id="token-form">
            <h2>üó∫Ô∏è Setup Instructions</h2>

            <h3 style="color: #4ecdc4; font-size: 14px; margin-top: 20px;">1. Mapbox Token (Optional - for satellite imagery)</h3>
            <input type="text" id="mapbox-token-input" placeholder="pk.eyJ1IjoieW91cnVzZXJuYW1lIiwi..." />
            <p style="font-size: 11px; margin-top: 5px;">Get free at <a href="https://account.mapbox.com/" target="_blank">account.mapbox.com</a></p>

            <h3 style="color: #4ecdc4; font-size: 14px; margin-top: 20px;">2. Cesium Ion Token (Required - for real terrain)</h3>
            <p style="font-size: 11px; margin-bottom: 8px; color: #ff6b6b;">‚ö†Ô∏è You need to add this token to the HTML file</p>
            <p style="font-size: 11px; margin-bottom: 8px;">
                1. Get free token: <a href="https://ion.cesium.com/signup" target="_blank">ion.cesium.com/signup</a><br>
                2. Copy your token<br>
                3. Open <code>globe_terrain.html</code> in a text editor<br>
                4. Find line 371: <code>const CESIUM_ION_TOKEN = 'YOUR_CESIUM...'</code><br>
                5. Replace with your token<br>
                6. Save and reload this page
            </p>

            <button onclick="startVisualization()">Launch Visualization</button>
            <p style="margin-top: 15px; font-size: 11px;">Or <a href="#" onclick="useDemoMode(); return false;">skip and use basic mode</a> (no real terrain, but cities/trees still work)</p>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="loading" style="display: none;">
        Loading 3D Globe and Terrain...
    </div>

    <!-- Cesium Container -->
    <div id="cesiumContainer"></div>

    <!-- Controls Hint -->
    <div id="controls-hint">
        üñ±Ô∏è Left-drag: Rotate | Scroll: Zoom | Right-drag: Pan | Middle-drag: Tilt
    </div>

    <!-- Title Panel -->
    <div id="title-panel" class="panel" style="display: none;">
        <h1>üåç Uzbekistan Relief</h1>
        <h2>Day 5 - Earth</h2>
        <p><strong>Real DEM Terrain Data</strong></p>
        <p>Navigate across Uzbekistan's diverse topography from the Aral Sea basin to Tian Shan peaks</p>
        <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
            <strong>Elevation Range:</strong><br>
            -12m (Aral Sea) to 4,643m (Khazret Sultan)
        </p>
    </div>

    <!-- Navigation Panel -->
    <div id="navigation-panel" class="panel" style="display: none;">
        <h3>üó∫Ô∏è Quick Navigation</h3>
        <button class="nav-button" onclick="flyToOverview()">View All Uzbekistan</button>
        <button class="nav-button" onclick="flyToTashkent()">Tashkent (Capital)</button>
        <button class="nav-button" onclick="flyToMountains()">Tian Shan Mountains</button>
        <button class="nav-button" onclick="flyToFergana()">Fergana Valley</button>
        <button class="nav-button" onclick="flyToSamarkand()">Samarkand</button>
        <button class="nav-button" onclick="flyToAralSea()">Aral Sea Basin</button>
        <button class="nav-button" onclick="flyToDesert()">Kyzylkum Desert</button>
        <button class="nav-button" onclick="flyToBukhara()">Bukhara</button>
    </div>

    <!-- Info Panel -->
    <div id="info-panel" class="panel" style="display: none;">
        <h3>üìä Current View</h3>
        <div class="info-row">
            <span class="info-label">Latitude:</span>
            <span class="info-value" id="info-lat">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Longitude:</span>
            <span class="info-value" id="info-lon">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Elevation:</span>
            <span class="info-value" id="info-elevation">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Camera Height:</span>
            <span class="info-value" id="info-height">-</span>
        </div>
    </div>

    <!-- Legend Panel -->
    <div id="legend-panel" class="panel" style="display: none;">
        <h3>üé® Legend</h3>
        <div class="legend-item">
            <div class="legend-icon" style="background: rgba(255,0,0,0.5); border: 2px solid red;"></div>
            <span>Uzbekistan Boundary</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: rgba(0,100,255,0.7);"></div>
            <span>Water Bodies</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #34a853;"></div>
            <span>Vegetation/Trees</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #c0c0c0;"></div>
            <span>Urban (Buildings)</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #ff0000; border-radius: 50%;"></div>
            <span>City Markers</span>
        </div>
    </div>

    <!-- Cesium Library -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>

    <script>
        // Global variables
        let viewer;
        let mapboxToken = '';

        // Configuration
        // Get your free Cesium Ion token at: https://ion.cesium.com/signup
        const CESIUM_ION_TOKEN = 'YOUR_CESIUM_ION_TOKEN_HERE'; // Replace with your token from https://ion.cesium.com/

        function useDemoMode() {
            mapboxToken = null;
            startVisualization();
        }

        function startVisualization() {
            const input = document.getElementById('mapbox-token-input').value.trim();
            if (input) {
                mapboxToken = input;
            }

            // Hide token modal
            document.getElementById('token-modal').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // Initialize Cesium
            setTimeout(initializeCesium, 100);
        }

        function initializeCesium() {
            // Set Cesium Ion token if provided
            if (CESIUM_ION_TOKEN && CESIUM_ION_TOKEN !== 'YOUR_CESIUM_ION_TOKEN_HERE') {
                Cesium.Ion.defaultAccessToken = CESIUM_ION_TOKEN;
            }

            // Viewer configuration
            const viewerConfig = {
                imageryProvider: mapboxToken ?
                    new Cesium.MapboxStyleImageryProvider({
                        styleId: 'satellite-v9',
                        accessToken: mapboxToken
                    }) :
                    new Cesium.createOpenStreetMapImageryProvider({
                        url: 'https://a.tile.openstreetmap.org/'
                    }),
                baseLayerPicker: false,
                geocoder: false,
                homeButton: true,
                sceneModePicker: false,
                navigationHelpButton: false,
                animation: false,
                timeline: false,
                fullscreenButton: true,
                vrButton: false,
                scene3DOnly: true,
                requestRenderMode: false,
                maximumRenderTimeChange: Infinity
            };

            // Create viewer
            viewer = new Cesium.Viewer('cesiumContainer', viewerConfig);

            // Add terrain if Cesium Ion token is available
            if (CESIUM_ION_TOKEN && CESIUM_ION_TOKEN !== 'YOUR_CESIUM_ION_TOKEN_HERE') {
                viewer.terrainProvider = new Cesium.CesiumTerrainProvider({
                    url: Cesium.IonResource.fromAssetId(1),
                    requestWaterMask: true,
                    requestVertexNormals: true
                });
            }

            // Enable lighting
            viewer.scene.globe.enableLighting = true;
            viewer.scene.globe.depthTestAgainstTerrain = CESIUM_ION_TOKEN && CESIUM_ION_TOKEN !== 'YOUR_CESIUM_ION_TOKEN_HERE';

            // Add data to globe
            addUzbekistanBoundary();
            addWaterBodies();
            addCities();
            addTrees();

            // Set initial view
            flyToOverview();

            // Hide loading
            document.getElementById('loading').style.display = 'none';

            // Show panels
            document.getElementById('title-panel').style.display = 'block';
            document.getElementById('navigation-panel').style.display = 'block';
            document.getElementById('info-panel').style.display = 'block';
            document.getElementById('legend-panel').style.display = 'block';

            // Update info panel
            viewer.camera.changed.addEventListener(updateInfoPanel);
            updateInfoPanel();
        }

        // Uzbekistan boundary (simplified polygon)
        function addUzbekistanBoundary() {
            const boundary = viewer.entities.add({
                name: 'Uzbekistan',
                polygon: {
                    hierarchy: Cesium.Cartesian3.fromDegreesArray([
                        55.5, 45.6,  // Northwest
                        61.0, 45.0,  // North
                        69.5, 44.0,  // Northeast
                        73.2, 43.2,  // East
                        73.2, 42.0,
                        73.0, 40.5,  // East center
                        71.0, 39.5,  // East south
                        69.0, 38.5,  // Southeast
                        67.0, 37.3,  // South
                        64.0, 36.0,  // Southwest
                        61.0, 37.0,
                        58.0, 38.5,
                        56.5, 41.0,
                        55.5, 42.5,
                        55.5, 45.6   // Back to start
                    ]),
                    material: Cesium.Color.RED.withAlpha(0.2),
                    outline: true,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 3,
                    height: 0
                }
            });
        }

        // Add water bodies
        function addWaterBodies() {
            // Aral Sea
            viewer.entities.add({
                name: 'Aral Sea',
                polygon: {
                    hierarchy: Cesium.Cartesian3.fromDegreesArray([
                        58.0, 46.0,
                        61.5, 46.5,
                        62.0, 45.0,
                        61.0, 43.5,
                        58.5, 43.8,
                        58.0, 46.0
                    ]),
                    material: Cesium.Color.fromCssColorString('#0064C8').withAlpha(0.7),
                    height: 0
                },
                description: 'Aral Sea - Lowest point in Uzbekistan (~-12m)'
            });

            // Amu Darya River
            viewer.entities.add({
                name: 'Amu Darya',
                polyline: {
                    positions: Cesium.Cartesian3.fromDegreesArray([
                        67.0, 37.0,
                        66.0, 38.5,
                        63.5, 40.0,
                        61.0, 42.0,
                        59.5, 43.5,
                        59.0, 44.5
                    ]),
                    width: 5,
                    material: Cesium.Color.CYAN.withAlpha(0.8),
                    clampToGround: true
                }
            });

            // Syr Darya River
            viewer.entities.add({
                name: 'Syr Darya',
                polyline: {
                    positions: Cesium.Cartesian3.fromDegreesArray([
                        73.0, 40.5,
                        71.0, 40.8,
                        68.5, 41.5,
                        66.0, 42.5,
                        63.0, 43.8,
                        61.0, 44.5
                    ]),
                    width: 5,
                    material: Cesium.Color.CYAN.withAlpha(0.8),
                    clampToGround: true
                }
            });
        }

        // Add cities with 3D buildings
        function addCities() {
            const cities = [
                { name: 'Tashkent', lon: 69.25, lat: 41.30, buildings: 50, height: 80 },
                { name: 'Samarkand', lon: 66.95, lat: 39.65, buildings: 30, height: 60 },
                { name: 'Bukhara', lon: 64.43, lat: 39.77, buildings: 20, height: 50 },
                { name: 'Fergana', lon: 71.78, lat: 40.38, buildings: 15, height: 50 },
                { name: 'Nukus', lon: 59.61, lat: 42.45, buildings: 10, height: 40 },
                { name: 'Khiva', lon: 60.36, lat: 41.38, buildings: 8, height: 35 },
                { name: 'Termez', lon: 67.28, lat: 37.23, buildings: 12, height: 45 },
                { name: 'Namangan', lon: 71.67, lat: 41.00, buildings: 15, height: 50 }
            ];

            cities.forEach(city => {
                // City marker
                viewer.entities.add({
                    name: city.name,
                    position: Cesium.Cartesian3.fromDegrees(city.lon, city.lat, 500),
                    point: {
                        pixelSize: 12,
                        color: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2
                    },
                    label: {
                        text: city.name,
                        font: 'bold 16px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 3,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -15),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });

                // 3D Buildings cluster
                for (let i = 0; i < city.buildings; i++) {
                    const offsetLon = city.lon + (Math.random() - 0.5) * 0.05;
                    const offsetLat = city.lat + (Math.random() - 0.5) * 0.05;
                    const buildingHeight = city.height + Math.random() * 40;

                    viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(offsetLon, offsetLat),
                        box: {
                            dimensions: new Cesium.Cartesian3(40, 40, buildingHeight),
                            material: Cesium.Color.LIGHTGRAY.withAlpha(0.8),
                            outline: true,
                            outlineColor: Cesium.Color.DARKGRAY
                        }
                    });
                }
            });
        }

        // Add trees
        function addTrees() {
            // Fergana Valley trees
            addTreeCluster(71.5, 40.3, 100, 'Fergana Valley');

            // Tian Shan foothills
            addTreeCluster(72.0, 41.5, 80, 'Tian Shan Foothills');

            // Samarkand region
            addTreeCluster(66.8, 39.5, 60, 'Samarkand Region');

            // Zarafshan Valley
            addTreeCluster(64.5, 40.0, 50, 'Zarafshan Valley');
        }

        function addTreeCluster(centerLon, centerLat, count, regionName) {
            for (let i = 0; i < count; i++) {
                const lon = centerLon + (Math.random() - 0.5) * 0.3;
                const lat = centerLat + (Math.random() - 0.5) * 0.3;
                const height = 8 + Math.random() * 7;

                viewer.entities.add({
                    name: `Tree (${regionName})`,
                    position: Cesium.Cartesian3.fromDegrees(lon, lat),
                    cylinder: {
                        length: height,
                        topRadius: 0,
                        bottomRadius: height * 0.3,
                        material: Cesium.Color.fromCssColorString('#228B22').withAlpha(0.8)
                    }
                });
            }
        }

        // Navigation functions
        function flyToOverview() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(64.0, 41.0, 1500000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-45),
                    roll: 0
                },
                duration: 3
            });
        }

        function flyToTashkent() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(69.25, 41.30, 15000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-30),
                    roll: 0
                },
                duration: 2.5
            });
        }

        function flyToMountains() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(71.5, 41.5, 50000),
                orientation: {
                    heading: Cesium.Math.toRadians(45),
                    pitch: Cesium.Math.toRadians(-20),
                    roll: 0
                },
                duration: 3
            });
        }

        function flyToFergana() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(71.78, 40.38, 80000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-40),
                    roll: 0
                },
                duration: 2.5
            });
        }

        function flyToSamarkand() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(66.95, 39.65, 20000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-35),
                    roll: 0
                },
                duration: 2.5
            });
        }

        function flyToAralSea() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(59.8, 45.0, 200000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-50),
                    roll: 0
                },
                duration: 3
            });
        }

        function flyToDesert() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(65.0, 42.0, 300000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-60),
                    roll: 0
                },
                duration: 3
            });
        }

        function flyToBukhara() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(64.43, 39.77, 18000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-30),
                    roll: 0
                },
                duration: 2.5
            });
        }

        // Update info panel
        function updateInfoPanel() {
            if (!viewer) return;

            const cameraPos = viewer.camera.positionCartographic;
            const lat = Cesium.Math.toDegrees(cameraPos.latitude).toFixed(4);
            const lon = Cesium.Math.toDegrees(cameraPos.longitude).toFixed(4);
            const height = (cameraPos.height / 1000).toFixed(1);

            document.getElementById('info-lat').textContent = lat + '¬∞';
            document.getElementById('info-lon').textContent = lon + '¬∞';
            document.getElementById('info-height').textContent = height + ' km';

            // Get terrain elevation at center of screen
            const centerScreen = new Cesium.Cartesian2(
                viewer.canvas.clientWidth / 2,
                viewer.canvas.clientHeight / 2
            );

            const ellipsoid = viewer.scene.globe.ellipsoid;
            const cartesian = viewer.camera.pickEllipsoid(centerScreen, ellipsoid);

            if (cartesian) {
                const cartographic = ellipsoid.cartesianToCartographic(cartesian);
                const terrainSamplePositions = [cartographic];

                Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, terrainSamplePositions)
                    .then(samples => {
                        if (samples && samples[0]) {
                            const elevation = Math.round(samples[0].height);
                            document.getElementById('info-elevation').textContent = elevation + ' m';
                        }
                    });
            }
        }
    </script>
</body>
</html>
